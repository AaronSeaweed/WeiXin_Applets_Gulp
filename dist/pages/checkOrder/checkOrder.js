"use strict";var app=getApp();Page({data:{paygoods:[],totalPrice:0,goodsCount:0,goodsTypeCount:0,userinfo:[],hideadd:0,grossPrice:0,goodsimg:[],deliveryprice:5},onLoad:function(){wx.showLoading({title:"加载中"})},onShow:function(){if(wx.getStorageSync("userinfo")){var t=wx.getStorageSync("userinfo");this.setData({userinfo:t,hideadd:0})}else this.setData({hideadd:1});setTimeout(function(){wx.hideLoading()},700);var o=wx.getStorageSync("cart")||[];for(var a in o)o[a].checked&&(this.data.goodsTypeCount++,this.data.totalPrice+=Number(o[a].price.toFixed(2))*o[a].count,this.data.goodsCount+=Number(o[a].count),this.data.paygoods.push(o[a]),this.data.goodsimg.push(o[a].img));this.setData({paygoods:this.data.paygoods,totalPrice:this.data.totalPrice.toFixed(2),goodsCount:this.data.goodsCount,goodsTypeCount:this.data.goodsTypeCount,grossPrice:Number(this.data.totalPrice.toFixed(2))+5,goodsimg:this.data.goodsimg})},onHide:function(){var t=this;setTimeout(function(){t.setData({totalPrice:0,goodsCount:0,goodsTypeCount:0,paygoods:[],goodsimg:[]})},500)},showgoodslist:function(){wx.navigateTo({url:"../checkOrder/goodslist"})},getUserInfo:function(){var o=this;wx.request({url:app.globalData.httpHost+"/weixin/getuserinfo",method:"POST",data:{},success:function(t){200==t.data.status&&"success"==t.data.message?(o.setData({userinfo:t.data.data[0]}),wx.setStorageSync("userinfo",t.data.data[0]),wx.hideLoading()):500==t.data.code&&o.setData({userinfo:[]})}})},setaddress:function(){wx.navigateTo({url:"../setaddress/setAddress"})},checkOrder:function(){if(wx.showLoading({title:"加载中"}),0==this.data.hideadd){var d=this;wx.request({url:app.globalData.httpHost+"/weixin/addorder",method:"POST",data:{goodtolprice:d.data.totalPrice,payprice:d.data.totalPrice,deliveryprice:d.data.deliveryprice,Reciinfo:d.data.userinfo.id,foodlist:d.data.paygoods},success:function(t){if(200==t.data.status&&"success"==t.data.message){var o=t.data.orderid.insertId;wx.hideLoading(),wx.navigateTo({url:"../order/orderDateil?orderid="+o});var a=wx.getStorageSync("cart")||[];for(var e in a)for(var s in d.data.paygoods)d.data.paygoods[s].foodid==a[e].foodid&&a.splice(e,1);wx.setStorageSync("cart",a)}else 500==t.data.code&&wx.showToast({title:"订单提交失败",icon:"none",duration:2e3})}})}else wx.showToast({title:"请选择收货地址",icon:"none",duration:2e3})}});